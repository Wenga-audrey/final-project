generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Track how a quiz was created
enum QuizSource {
  MANUAL
  AI
}

enum Role {
  LEARNER
  TEACHER
  PREP_ADMIN
  SUPER_ADMIN
}

enum PaymentStatus {
  PENDING
  PAID
  EXPIRED
  REFUNDED
}

enum PaymentMethod {
  ORANGE_MONEY
  MTN_MOMO
  BANK_TRANSFER
  CASH
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  firstName         String
  lastName          String
  password          String
  avatar            String?
  role              Role     @default(LEARNER)
  phone             String?
  paymentStatus     PaymentStatus @default(PENDING)
  isEmailVerified   Boolean  @default(false)
  emailVerifyToken  String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  lastLoginAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  enrollments       Enrollment[]
  chapterProgress   ChapterProgress[]
  quizResults       QuizResult[]
  payments          Payment[]
  forumTopics       ForumTopic[]
  forumReplies      ForumReply[]
  forumLikes        ForumLike[]
  sentMessages      PrivateMessage[] @relation("MessageSender")
  receivedMessages  PrivateMessage[] @relation("MessageRecipient")
  teachingClasses   ClassTeacher[]
  announcements     Announcement[]
  // Back-relations for new models
  createdChapterQuizzes ChapterQuiz[] @relation("UserCreatedChapterQuizzes")
  createdSubjectQuizzes SubjectQuiz[] @relation("UserCreatedSubjectQuizzes")
  notifications         Notification[]
  classReviews          ClassReview[]
  // Missing relations that need to be added
  studyGroupsCreated    StudyGroup[] @relation("StudyGroupCreator")
  studyGroupMemberships StudyGroupMember[]
  studyGroupMessages    StudyGroupMessage[]
  userAchievements      UserAchievement[]
  scheduledSessions     ScheduledSession[]
  availability          UserAvailability[]
  // New relations for accessibility, content management, and integrations
  accessibilityPreferences AccessibilityPreference?
  contentVersions          ContentVersion[]
  calendarIntegrations     CalendarIntegration[]
  calendarEvents           CalendarEvent[]
  educationalIntegrations  EducationalResourceIntegration[]
  apiTokens                APIToken[]
  socialShares             SocialShare[]

  @@map("users")
}

model PreparatoryClass {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  examType    String   // ENAM, ENS, POLICE, CUSTOMS, etc.
  startDate   DateTime
  endDate     DateTime
  price       Decimal  @db.Decimal(10, 2)
  maxStudents Int      @default(50)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subjects      Subject[]
  enrollments   Enrollment[]
  teachers      ClassTeacher[]
  payments      Payment[]
  announcements Announcement[]
  classReviews  ClassReview[]
  // Missing relations that need to be added
  studyGroups   StudyGroup[]
  scheduledSessions ScheduledSession[]

  @@map("preparatory_classes")
}

model Subject {
  id          String   @id @default(cuid())
  classId     String
  name        String   // Mathematics, French, History, etc.
  description String?  @db.Text
  order       Int      // Subject order in curriculum
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class     PreparatoryClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  chapters  Chapter[]
  quizzes   SubjectQuiz[]

  @@map("subjects")
}

model Chapter {
  id          String   @id @default(cuid())
  subjectId   String
  title       String
  description String?  @db.Text
  order       Int      // Chapter order within subject
  duration    Int      @default(60) // Expected duration in minutes
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  lessons   Lesson[]
  quizzes   ChapterQuiz[]
  progress  ChapterProgress[]

  @@map("chapters")
}

model Lesson {
  id          String   @id @default(cuid())
  chapterId   String
  title       String
  content     String?  @db.LongText
  videoUrl    String?
  documentUrl String?  // PDF, PPT files
  order       Int
  duration    Int      @default(45) // minutes
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  // Missing relation that needs to be added
  scheduledSessions ScheduledSession[]
  // New relations for content management
  multimediaContent       MultimediaContent[]
  interactiveSimulations  InteractiveSimulation[]

  @@map("lessons")
}

model ChapterProgress {
  id          String    @id @default(cuid())
  userId      String
  chapterId   String
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  timeSpent   Int       @default(0) // minutes
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@unique([userId, chapterId])
  @@map("chapter_progress")
}

model ChapterQuiz {
  id          String   @id @default(cuid())
  chapterId   String
  title       String
  description String?  @db.Text
  timeLimit   Int      @default(30) // minutes
  passingScore Int     @default(60) // percentage
  isActive    Boolean  @default(true)
  // Who created and how it was created
  createdById String
  source      QuizSource @default(MANUAL)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  chapter   Chapter      @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  createdBy User         @relation("UserCreatedChapterQuizzes", fields: [createdById], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  results   QuizResult[]

  @@map("chapter_quizzes")
}

model SubjectQuiz {
  id          String   @id @default(cuid())
  subjectId   String
  title       String
  description String?  @db.Text
  timeLimit   Int      @default(120) // minutes
  passingScore Int     @default(60) // percentage
  isActive    Boolean  @default(true)
  // Who created and how it was created
  createdById String
  source      QuizSource @default(MANUAL)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subject   Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  createdBy User         @relation("UserCreatedSubjectQuizzes", fields: [createdById], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  results   QuizResult[]

  @@map("subject_quizzes")
}

model QuizQuestion {
  id              String  @id @default(cuid())
  chapterQuizId   String?
  subjectQuizId   String?
  question        String  @db.Text
  type            String  @default("multiple-choice")
  options         Json?   // For multiple choice questions
  correctAnswer   String
  explanation     String? @db.Text
  difficulty      String  @default("MEDIUM")
  points          Int     @default(1)
  order           Int
  isAIGenerated   Boolean @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  chapterQuiz ChapterQuiz? @relation(fields: [chapterQuizId], references: [id], onDelete: Cascade)
  subjectQuiz SubjectQuiz? @relation(fields: [subjectQuizId], references: [id], onDelete: Cascade)

  @@map("quiz_questions")
}

model QuizResult {
  id              String   @id @default(cuid())
  userId          String
  chapterQuizId   String?
  subjectQuizId   String?
  score           Int
  maxScore        Int
  timeSpent       Int      // minutes
  answers         Json     // User answers and analysis
  weakAreas       Json?    // AI-identified weak areas
  suggestions     Json?    // AI suggestions for improvement
  completedAt     DateTime @default(now())

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapterQuiz ChapterQuiz? @relation(fields: [chapterQuizId], references: [id], onDelete: Cascade)
  subjectQuiz SubjectQuiz? @relation(fields: [subjectQuizId], references: [id], onDelete: Cascade)

  @@map("quiz_results")
}

model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  classId   String
  status    String   @default("ACTIVE") // ACTIVE, COMPLETED, SUSPENDED
  enrolledAt DateTime @default(now())
  completedAt DateTime?

  // Relations
  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  class PreparatoryClass @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
  @@map("enrollments")
}

model ClassTeacher {
  id        String   @id @default(cuid())
  classId   String
  teacherId String
  subjectId String?  // Teacher can be assigned to specific subjects
  role      String   @default("TEACHER") // TEACHER, HEAD_TEACHER
  assignedAt DateTime @default(now())

  // Relations
  class   PreparatoryClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher User             @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([classId, teacherId, subjectId])
  @@map("class_teachers")
}

model Payment {
  id            String        @id @default(cuid())
  userId        String
  classId       String
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       // External payment reference
  phoneNumber   String?       // For mobile money payments
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  class PreparatoryClass @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Announcement {
  id        String   @id @default(cuid())
  classId   String
  authorId  String
  title     String
  content   String   @db.Text
  isUrgent  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  class  PreparatoryClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  author User             @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("announcements")
}

model ForumTopic {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  category  String
  views     Int      @default(0)
  isPinned  Boolean  @default(false)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author   User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  replies  ForumReply[]
  likes    ForumLike[]

  @@map("forum_topics")
}

model ForumReply {
  id        String   @id @default(cuid())
  content   String   @db.Text
  topicId   String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  topic  ForumTopic  @relation(fields: [topicId], references: [id], onDelete: Cascade)
  author User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  likes  ForumLike[]

  @@map("forum_replies")
}

model ForumLike {
  id      String  @id @default(cuid())
  userId  String
  topicId String?
  replyId String?

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic ForumTopic? @relation(fields: [topicId], references: [id], onDelete: Cascade)
  reply ForumReply? @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@unique([userId, replyId])
  @@map("forum_likes")
}

model PrivateMessage {
  id          String   @id @default(cuid())
  senderId    String
  recipientId String
  content     String   @db.Text
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  sender    User @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient User @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@map("private_messages")
}

// In-app notifications for users
model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String   @db.Text
  type      String   @default("info") // info, quiz, announcement, system
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// Learner reviews and ratings for a preparatory class (exam)
model ClassReview {
  id        String   @id @default(cuid())
  userId    String
  classId   String
  rating    Int      // 1-5
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  class PreparatoryClass @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
  @@index([classId])
  @@map("class_reviews")
}

// Study groups for collaborative learning
model StudyGroup {
  id          String   @id @default(cuid())
  name        String
  description String   @db.Text
  maxMembers  Int      @default(10)
  classId     String
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class     PreparatoryClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  createdBy User             @relation("StudyGroupCreator", fields: [createdById], references: [id], onDelete: Cascade)
  members   StudyGroupMember[]
  messages  StudyGroupMessage[]

  @@map("study_groups")
}

model StudyGroupMember {
  id          String   @id @default(cuid())
  userId      String
  studyGroupId String
  role        String   @default("MEMBER") // MEMBER, ADMIN
  joinedAt    DateTime @default(now())

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  studyGroup StudyGroup @relation(fields: [studyGroupId], references: [id], onDelete: Cascade)

  @@unique([userId, studyGroupId])
  @@map("study_group_members")
}

model StudyGroupMessage {
  id          String   @id @default(cuid())
  studyGroupId String
  userId      String
  content     String   @db.Text
  createdAt   DateTime @default(now())

  // Relations
  studyGroup StudyGroup @relation(fields: [studyGroupId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_group_messages")
}

// Achievement system for gamification
model Achievement {
  id          String   @id @default(cuid())
  name        String
  description String   @db.Text
  category    String
  points      Int      @default(10)
  icon        String?
  criteria    Json     // Criteria for unlocking (e.g., {"type": "quiz_score", "value": 80})
  isHidden    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id           String   @id @default(cuid())
  userId       String
  achievementId String
  unlockedAt   DateTime @default(now())
  progress     Int      @default(0) // For achievements with progress tracking
  metadata     Json?    // Additional data about how the achievement was earned

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  // New relation for social sharing
  socialShares SocialShare[]

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// Calendar events and scheduled sessions
model ScheduledSession {
  id              String   @id @default(cuid())
  userId          String
  courseId        String?
  lessonId        String?
  title           String
  description     String?  @db.Text
  scheduledAt     DateTime
  duration        Int      // minutes
  type            String   // lesson, assessment, review, practice, study_group, live_session
  priority        Int      @default(5) // 1-10
  status          String   @default("scheduled") // scheduled, in_progress, completed, missed, cancelled
  aiRecommendation String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course PreparatoryClass?  @relation(fields: [courseId], references: [id], onDelete: SetNull)
  lesson Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  @@map("scheduled_sessions")
}

model UserAvailability {
  id        String   @id @default(cuid())
  userId    String
  dayOfWeek Int      // 0-6 (Sunday-Saturday)
  startTime String   // HH:MM format
  endTime   String   // HH:MM format
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek, startTime])
  @@map("user_availability")
}

// Accessibility preferences for users
model AccessibilityPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  screenReader      Boolean  @default(false)
  highContrast      Boolean  @default(false)
  textSize          String   @default("normal") // normal, large, extra-large
  textToSpeech      Boolean  @default(false)
  keyboardNavigation Boolean @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accessibility_preferences")
}

// Multimedia content for lessons
model MultimediaContent {
  id          String   @id @default(cuid())
  lessonId    String
  type        String   // video, image, audio, animation, diagram
  url         String
  title       String?
  description String?  @db.Text
  metadata    Json?    // Additional data like dimensions, duration, etc.
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("multimedia_content")
}

// Interactive simulations for complex topics
model InteractiveSimulation {
  id          String   @id @default(cuid())
  lessonId    String
  title       String
  description String?  @db.Text
  type        String   // physics, chemistry, biology, etc.
  parameters  Json     // Configuration parameters for the simulation
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("interactive_simulations")
}

// Content versioning and update tracking
model ContentVersion {
  id           String   @id @default(cuid())
  contentId    String
  versionNumber String
  changes      Json     // Description of changes made
  authorId     String
  notes        String?  @db.Text
  createdAt    DateTime @default(now())

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("content_versions")
}

// Multilingual content support
model MultilingualContent {
  id        String   @id @default(cuid())
  contentId String
  language  String   // ISO language code (fr, en, etc.)
  title     String?
  description String? @db.Text
  content   String?  @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contentId, language])
  @@map("multilingual_content")
}

// Calendar integration for study scheduling
model CalendarIntegration {
  id           String   @id @default(cuid())
  userId       String
  provider     String   // google, outlook, etc.
  accessToken  String
  refreshToken String?
  calendarId   String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  calendarEvents CalendarEvent[]

  @@unique([userId, provider])
  @@map("calendar_integrations")
}

// Calendar events
model CalendarEvent {
  id                   String   @id @default(cuid())
  userId               String
  title                String
  description          String?  @db.Text
  startTime            DateTime
  endTime              DateTime
  eventType            String   @default("STUDY_SESSION") // STUDY_SESSION, EXAM, BREAK, etc.
  calendarIntegrationId String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  calendarIntegration CalendarIntegration @relation(fields: [calendarIntegrationId], references: [id], onDelete: Cascade)

  @@map("calendar_events")
}

// Educational resource integrations
model EducationalResourceIntegration {
  id        String   @id @default(cuid())
  userId    String
  name      String
  url       String
  type      String   // VIDEO_PLATFORM, DOCUMENT_LIBRARY, etc.
  apiKey    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("educational_resource_integrations")
}

// API tokens for third-party integrations
model APIToken {
  id          String   @id @default(cuid())
  userId      String
  name        String
  token       String   @unique
  permissions Json     // Array of permissions
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_tokens")
}

// Social media sharing records
model SocialShare {
  id           String   @id @default(cuid())
  userId       String
  achievementId String?
  platform     String   // facebook, twitter, linkedin, etc.
  sharedAt     DateTime @default(now())
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement UserAchievement? @relation(fields: [achievementId], references: [id], onDelete: SetNull)

  @@map("social_shares")
}
